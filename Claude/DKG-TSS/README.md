# Testing Procedure for the Coordinator-Based Threshold Signature System

This guide provides the complete step-by-step procedure for setting up and testing the threshold signature system. The architecture consists of three **Signer** nodes that hold secret key shares and one **Coordinator** node that orchestrates all protocol flows.

As a user, you will only ever interact directly with the Coordinator.

## System Setup

For this test, you will need **five separate terminal windows** running simultaneously.

### 1. Start the Signer Nodes

In the first three terminals, start each of the `signer.py` party nodes. They will launch and wait for instructions from the Coordinator.

#### Terminal 1: Signer 1 (Port 5001)
```bash
python signer.py \
    --party_id 1 \
    --port 5001 \
    --num_parties 3 \
    --threshold 2 \
    --party_addresses "1:localhost:5001" "2:localhost:5002" "3:localhost:5003"
```

#### Terminal 2: Signer 2 (Port 5002)
```bash
python signer.py \
    --party_id 2 \
    --port 5002 \
    --num_parties 3 \
    --threshold 2 \
    --party_addresses "1:localhost:5001" "2:localhost:5002" "3:localhost:5003"
```

#### Terminal 3: Signer 3 (Port 5003)
```bash
python signer.py \
    --party_id 3 \
    --port 5003 \
    --num_parties 3 \
    --threshold 2 \
    --party_addresses "1:localhost:5001" "2:localhost:5002" "3:localhost:5003"
```

### 2. Start the Coordinator Node

In your fourth terminal, start the `coordinator.py` script. It will listen for your commands on port `6000`.

#### Terminal 4: Coordinator (Port 6000)
```bash
python coordinator.py
```

*Your fifth terminal will be your **testing terminal** for running the `curl` commands.*

---

## Testing the Protocol

From your testing terminal, you will now execute just two API calls to the Coordinator to run the entire protocol.

### Phase 1: Perform Distributed Key Generation (DKG)

This single command instructs the Coordinator to manage the entire multi-round DKG process. The result is a shared public key securely generated by the Signer nodes.

```bash
curl -X POST http://localhost:6000/dkg/start
```

#### Expected Output
You can watch the logs in all four server terminals to see the activity. The Coordinator will respond with a final success message.

```json
{
  "status": "success",
  "message": "DKG OK",
  "aggregated_public_key": {
    "x": "0x...",
    "y": "0x..."
  }
}
```

### Phase 2: Request a Threshold Signature

Once DKG is complete, this single command instructs the Coordinator to generate a signature. The JSON payload specifies the message to be signed (as a hash) and which parties should participate in the signing ceremony.

For this example, **Parties 1 and 3** will act as the signers.

Prep your message_hash_hex (example):

```bash
echo -n "test message" | sha256sum | awk '{print $1}'
3f0a377ba0a4a460ecb616f6507ce0d8cfa3e704025d4fda3ed0c5ca05468728
```

```bash
curl -X POST -H "Content-Type: application/json" \
     -d '{
         "message_hash_hex": "3f0a377ba0a4a460ecb616f6507ce0d8cfa3e704025d4fda3ed0c5ca05468728",
         "signing_party_ids": [1, 3]
     }' \
     http://localhost:6000/request-signature
```

#### Expected Output
The Coordinator will handle the entire multi-round signing protocol and return the final, cryptographically valid ECDSA signature.

```json
{
  "status": "success",
  "signature": {
    "r": "0x...",
    "s": "0x..."
  }
}
```

---

## Stopping the System

When you are finished testing, you can stop all servers by going into each of their respective terminals (Terminals 1, 2, 3, and 4) and pressing `Ctrl+C`.